name: Deploy Vue App PROD

on:
  workflow_dispatch:

env:
  S3_BUCKET: canva-dev-90
  S3_ASSETS_PATH: assets
  DEV_EC2_PATH: /usr/share/nginx/my-vue-app

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Build for dev and upload assets to S3
      - name: Build Vue project (dev)
        run: pnpm run build:dev

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::977324179069:role/GitHubActionsDeployRole
          aws-region: ap-northeast-1

      - name: Upload assets to S3
        run: |
          aws s3 sync dist/assets/ s3://${{ env.S3_BUCKET }}/${{ env.S3_ASSETS_PATH }}/ \
            --delete \
            --cache-control "max-age=31536000,public,immutable"

      # Setup SSH once
      - name: Setup SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
        env:
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$EC2_HOST "echo 'SSH connection successful!'"
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}

      # Deploy all three index.html files
      - name: Deploy index.html files to EC2
        run: |
          # Deploy dev
          echo "Deploying dev index.html..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no index.html deploy@$EC2_HOST:/tmp/index.html
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$EC2_HOST \
            "sudo mv /tmp/index.html ${{ env.DEV_EC2_PATH }}/index.html"

        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}

      - name: Deployment complete
        run: |
          echo "ðŸŽ‰ Deployment complete!"
          echo "Dev: http://ec2.charihettiarachchi.it.com"
          echo "Staging: Check your staging URL"
          echo "Integration: Check your integration URL"
