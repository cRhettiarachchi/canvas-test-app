# name: Deploy Vue App
# on:
#   push:
#     branches: [main]
#   workflow_dispatch:
#     inputs:
#       environment:
#         description: 'Environment'
#         required: true
#         type: choice
#         options:
#           - dev
#         default: dev

# # Add permissions for OIDC
# permissions:
#   id-token: write # Required for OIDC
#   contents: read # Required for checkout

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Install pnpm
#         uses: pnpm/action-setup@v4
#         with:
#           version: 9

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '22'
#           cache: 'pnpm'

#       - name: Install dependencies
#         run: pnpm install --frozen-lockfile

#       - name: Build Vue project
#         run: pnpm run build:dev

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           role-to-assume: arn:aws:iam::977324179069:role/GitHubActionsDeployRole
#           aws-region: ap-northeast-1

#       - name: Upload assets to S3
#         run: |
#           aws s3 sync dist/assets/ s3://canva-dev-90/assets/ \
#             --delete \
#             --cache-control "max-age=31536000,public,immutable"

#       - name: Setup SSH (with verbose output)
#         run: |
#           set -e
#           echo "Creating .ssh directory..."
#           mkdir -p ~/.ssh

#           echo "Writing SSH key..."
#           echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/deploy_key

#           echo "Setting permissions..."
#           chmod 600 ~/.ssh/deploy_key

#           echo "Verifying key file..."
#           ls -la ~/.ssh/deploy_key
#           head -n 1 ~/.ssh/deploy_key

#           echo "Scanning SSH host: $EC2_HOST"
#           ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts || { echo "ssh-keyscan failed"; exit 1; }

#           echo "SSH setup complete!"
#         env:
#           EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
#           EC2_HOST: ${{ secrets.EC2_HOST }}

#       - name: Test SSH Connection
#         run: |
#           echo "Testing SSH connection..."
#           ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$EC2_HOST "echo 'SSH connection successful!'" || { echo "SSH connection failed"; exit 1; }
#         env:
#           EC2_HOST: ${{ secrets.EC2_HOST }}

#       - name: Deploy index.html to EC2
#         run: |
#           echo "Copying index.html..."
#           scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no dist/index.html deploy@$EC2_HOST:/tmp/index.html

#           echo "Moving to nginx directory"
#           ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$EC2_HOST "sudo mv /tmp/index.html /usr/share/nginx/my-vue-app/index.html"
#         env:
#           EC2_HOST: ${{ secrets.EC2_HOST }}

#       - name: Deployment complete
#         run: echo "ðŸŽ‰ Deployed to http://ec2.charihettiarachchi.it.com"

name: Deploy Vue App
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
        default: dev

# Add permissions for OIDC
permissions:
  id-token: write # Required for OIDC
  contents: read # Required for checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Vue project
        run: pnpm run build:dev

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::977324179069:role/GitHubActionsDeployRole
          aws-region: ap-northeast-1

      - name: Upload assets to S3
        run: |
          aws s3 sync dist/assets/ s3://canva-dev-90/assets/ \
            --delete \
            --cache-control "max-age=31536000,public,immutable"

      - name: Setup SSH (with verbose output)
        run: |
          set -e
          echo "Creating .ssh directory..."
          mkdir -p ~/.ssh

          echo "Writing SSH key..."
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/deploy_key

          echo "Setting permissions..."
          chmod 600 ~/.ssh/deploy_key

          echo "Verifying key file..."
          ls -la ~/.ssh/deploy_key
          head -n 1 ~/.ssh/deploy_key

          echo "Scanning SSH host: $EC2_HOST"
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts || { echo "ssh-keyscan failed"; exit 1; }

          echo "SSH setup complete!"
        env:
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$EC2_HOST "echo 'SSH connection successful!'" || { echo "SSH connection failed"; exit 1; }
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}

      - name: Deploy index.html to EC2
        run: |
          echo "Copying index.html..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no dist/index.html deploy@$EC2_HOST:/tmp/index.html

          echo "Moving to nginx directory"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$EC2_HOST "sudo mv /tmp/index.html /usr/share/nginx/my-vue-app/index.html"
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}

      - name: Deployment complete
        run: echo "ðŸŽ‰ Deployed to http://ec2.charihettiarachchi.it.com"
